{% extends 'Base.html.jinja' %}
{% block headercontent %}
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
	<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
{% endblock %}

{% block content %}
	<h2 style="text-align: center; margin-top: 10px;">Tickets</h2>
	<div id="id_table1" style="padding: 5px; margin-top: 20px;">
		{{ table.__html__() }}
	</div>

    <footer class="footer fixed-bottom badge-light" style="padding-bottom: 5px; flex: right; background: ; box-shadow: -1px 0px 7px 1px gray;">
    </footer>

	<script>
		(function(){
			{% if userinfo.role_index < 1 %}
				document.querySelectorAll('.cls_edit_ticket').forEach(element => {element.remove();});
				document.querySelectorAll('.cls_clone_ticket').forEach(element => {element.remove();});
				document.querySelectorAll('.cls_create_jira').forEach(element => {element.remove();});
				document.querySelectorAll('.create_relval_id').forEach(element => {element.remove();});
				document.querySelectorAll('.delete_ticket').forEach(element => {element.remove();});
			{% endif %}
		})();
	</script>

	<style type="text/css">
		/*Makee rows compact*/
		table.dataTable tbody td {
		  padding: 3px 10px;
		}

		.pagecounter{
			margin-left: 10px;
			float: right;
		}
	</style>

	<script type="text/javascript">

		var datatable = $('#ticket_list').DataTable({
					"scrollX": true,
					"pageLength": 50,
					"bStateSave": true,
	                "dom": '<"top"lf>rt<"pagecounter dataTables_wrapper no-footer"ip><"clear">',
				    initComplete: (settings, json)=>{
				        $('.table_info').appendTo('footer');
				        $('.pagecounter').appendTo('footer');
				    },
			});

		function create_relval(prepid) {
	      var req = new XMLHttpRequest();
	      const message = 'You can NOT modify the ticket once relvals are created. You need to create new ticket for further addition. Do you want to proceed?';
		  activateConfirmModal('Create Relvals for <b>'+ prepid+'</b>?', message);
		  $('#goahead_confirmationModal').on('click', function(){
			$('#confirmationModal').modal('toggle');
			$('body').addClass('loading');
		    req.onreadystatechange = alertContents;
		    req.open('POST', 'api/tickets/create_relvals');
			req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
		    req.send('prepid='+ prepid);
		  });

 		  function alertContents() {
		    if (req.readyState === XMLHttpRequest.DONE) {
		      if (req.status === 200) {
				window.location.reload(false);
				window.onload = function() { $('body').removeClass('loading');}
		      } else {
			    $('body').removeClass('loading');
			    const AlertIcon = '<i class="bi bi-exclamation-triangle" style="color:red"></i>';
		        alertModal(AlertIcon +' There was a problem with the request', JSON.parse(req.responseText).message);
		      }
		    }
		  }
		}

		function delete_ticket(prepid) {
		    req = new XMLHttpRequest();
			const message = 'Do you want to proceed?';
			activateConfirmModal('Deleting a Ticket <b>'+ prepid+'</b>?', message);
			$('#goahead_confirmationModal').on('click', function(){
				$('#confirmationModal').modal('toggle');
				$('body').addClass('loading');
				req.onreadystatechange = alertContents;
				req.open('DELETE', 'api/tickets/delete');
				req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
				req.send('prepid='+ prepid);
			});

			function alertContents() {
				if (req.readyState === XMLHttpRequest.DONE) {
				  if (req.status === 200) {
					window.location.reload(false);
					window.onload = function() { $('body').removeClass('loading');}
				  } else {
				    $('body').removeClass('loading');
				    const AlertIcon = '<i class="bi bi-exclamation-triangle" style="color:red"></i>';
				    alertModal(AlertIcon +' There was a problem with the request', JSON.parse(req.responseText).message);
				  }
				}
			}
		}

	</script>
{% endblock %}